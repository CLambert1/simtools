---
title: "Simulate individual movements"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{simulate-individual-movements}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(simtools)
```

<!-- WARNING - This vignette is generated by {fusen} from dev/flat_simulate_mvmt.Rmd: do not edit by hand -->

# Define potential next positions

Generating a bunch of potential positions to chose the next step from. Positions are generated based on provided bearing (Von Mises distribution) and step distributions (gamma distribution). For each positions, the value of env_rast is retrieved as well as the distance from the colony location. 


```{r example-potential_position_func}
from <- data.frame(Lon = 1, Lat = 2, toto = 5)
colony.location <- data.frame(Lon = 2, Lat = 5)
cdt <- generate_env_layer(grid = create_grid(), n = 1)$rasters
potential_position_func(n = 10, from = from, 
                        colony.location = colony.location, resource.layer = cdt, 
                        bearing = c(90,10), step = c(4.5, 3))
```

  

# Simulate the trajectory of a single central-place forager

Simulate a full foraging trajectory of an individual departing from its colony. The individual launches its trip at a given time period (starting.hour, ymd_hms format) and starts its returning trip either when at a given distance from its colony (provided with max.dist) or when an hour before sunset. The user can define the bearing and step distributions for the departing step, but also for the travelling and foraging bouts. By default, travelling are set to be directed movement patterns (large steps with low variability, low angles with low variability) and foraging to be area-restricted movements (short steps with low variability, large angles with large variability). 
The user can define the step duration, that is the time interval at which the positions are sampled.  

For each position, ten potential subsequent positions are randomly sampled using `potential_position_func()`, that is with movement parameters based on the activity the individual is engaged in at the previous step (travelling or foraging). The environmental suitability (a raster layer provided with resource.layer) is retrieved for each potential point based on their geographic coordinates, and their distance from the colony is computed using the rdist function from the fields package. 

The first four positions of the track after colony departure are randomly selected within the ten potential points sampled as described above, using travelling movement. Afterwards, subsequent positions are randomly sampled among the four out of ten potential points which have the highest values of environmental suitability. If the environmental suitability exceeds a given threshold (activity.threshold), the individual switches to foraging movements; if not, the individual continues travelling.

When individuals reaches the threshold distance to colony (max.dist), or the trip duration exceeds the given duration (max.duration), they start their homeward journey. Potential next positions are sampled using only travelling movement parameters, and the next positions are selected based on the minimum distance to the colony. If several potential positions meet the selection criteria, the next step is randomly sampled within these positions. An individual is considered back when within 0.5 spatial unit (the unit depends on the provided resource layer) from the colony.


  

```{r example-simulate_trajectory_CPF}
library(ggplot2)
library(viridis)
library(tidyterra)
library(lubridate)
library(terra)
colony.location <- data.frame(Lon = 20, Lat = 20)
cdt <- generate_env_layer(grid = create_grid(), n = 1, seed = 25)
daylength <- insol::daylength(long = colony.location$Lon, 
                              lat = colony.location$Lat, 
                              jd = insol::JD(as.POSIXct("2022-08-01", tz = "UTC")), tmz = 0)
sunrise <- format(as.POSIXct(daylength[,1]*3600, 
                             origin = as.POSIXct("2022-08-01", tz = "UTC"), "%H:%M", tz = "UTC"))
    
# launch a travel for a duration of 12h
single.traj <- simulate_trajectory_CPF(initial.position = colony.location, 
                    resource.layer = cdt$rasters, 
                    starting.hour = ymd_hms(sunrise), # departs at sunrise
                    starting.bearing = c(90,10), 
                    starting.step = c(4.5, 3),
                    travel.bearing = c(0, 20), 
                    travel.step = c(3, 3), 
                    foraging.bearing = c(0, 0.5), 
                    foraging.step = c(1, 3),
                    minx = 0, maxx = 90, 
                    miny = 0, maxy = 90,
                    max.dist = 40,
                    step.duration = 5,
                    activity.threshold = 0.70,
                    max.duration = 720)

# view the trajectory
ggplot(single.traj) +
  geom_spatraster(data = cdt$rasters) + 
  geom_point(aes(x = Lon, y = Lat, color = activity)) +
  geom_point(data = colony.location, aes(x = Lon, y = Lat), col = "red") +
  scale_fill_viridis(option = "H") 

# look at the density distribution of distance to colony and movement parameters
ggplot(single.traj) + geom_density(aes(x = dist.col))
ggplot(single.traj |> subset(activity %in% c("forage", "travel"))) + geom_density(aes(x = angle)) + facet_wrap("activity")
ggplot(single.traj |> subset(activity %in% c("forage", "travel"))) + geom_density(aes(x = step)) + facet_wrap("activity")

```

  

  


# Simulate the trajectory of a non-central place forager

Same as above, but the individual is not restrained around its colony and does not perform homing bout. 

Should add a condition on the time spent around a same area. 
    

  

```{r example-simulate_trajectory_FR}
library(ggplot2)
library(viridis)
library(tidyterra)
library(lubridate)
colony.location <- data.frame(Lon = 50, Lat = 50)
cdt <- generate_env_layer(grid = create_grid(), n = 1, seed = 4)
terra::plot(cdt$rasters)
# determine the sunrise hour for a random dat
daylength <- insol::daylength(long = colony.location$Lon, 
                              lat = colony.location$Lat, 
                              jd = insol::JD(as.POSIXct("2022-08-01", tz = "UTC")), tmz = 0)
sunrise <- format(as.POSIXct(daylength[,1]*3600, 
                             origin = as.POSIXct("2022-08-01", tz = "UTC"), "%H:%M", tz = "UTC"))
    
single.traj <- simulate_trajectory_FR(initial.position = colony.location, 
                    resource.layer = cdt$rasters, 
                    starting.hour = ymd_hms(sunrise), # departs at sunrise
                    starting.bearing = c(90,10), 
                    starting.step = c(4.5, 3),
                    travel.bearing = c(0, 20), 
                    travel.step = c(3, 3), 
                    foraging.bearing = c(0, 0.5), 
                    foraging.step = c(1, 3),
                    minx = 0, maxx = 90, 
                    miny = 0, maxy = 90,
                    step.duration = 1,
                    activity.threshold = 0.7,
                    max.duration = 2000)

# view the trajectory
ggplot(single.traj) +
  geom_spatraster(data = cdt$rasters) + 
  geom_point(aes(x = Lon, y = Lat, color = activity)) +
  geom_point(data = colony.location, aes(x = Lon, y = Lat), col = "red") +
  scale_fill_viridis(option = "H") 

# look at the density distribution of distance to colony and movement parameters
ggplot(single.traj) + geom_density(aes(x = dist.col))
ggplot(single.traj |> subset(activity %in% c("forage", "travel"))) + geom_density(aes(x = angle)) + facet_wrap("activity")
ggplot(single.traj |> subset(activity %in% c("forage", "travel"))) + geom_density(aes(x = step)) + facet_wrap("activity")


```

  

  




